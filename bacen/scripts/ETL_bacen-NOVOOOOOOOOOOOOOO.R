# script feito por André Luiz Brito em 14-03-2025
# checado em 14-03-2025

# CLEAR ENVIRONMENT --------------------------------------------------------

# Remove all objects from the environment
rm(list = ls())

# PARAMETERS -------------------------------------------------------------------

output_folder = "G:/BB8555-GEASE/Interna/Dados/Brasil/Crédito/datalake"

file_name = "teste"

ids_bacen = c(
  28183,28184,28185,28186,28187,28188,28189,28190,28191,28192,28193,28194,28195,28196,28197,28198,28199,28200,28201,28202,28203,28204,28205,28206,28207,28208,28209,28210,28211,28212,28213,28214,28846,28847,28848,28849,28850,28851,28852,28853,28854,28855,28856,28857,28858,28859,28860,28861,28862,28863,28864,28865,28866,2007,2043,12106,12150,20539,20540,20541,20542,20543,20544,20545,20546,20547,20548,20549,20550,20551,20552,20553,20554,20555,20556,20557,20558,20559,20560,20561,20562,20563,20564,20565,20566,20567,20568,20569,20570,20571,20572,20573,20574,20575,20576,20577,20578,20579,20580,20581,20582,20583,20584,20585,20586,20587,20588,20589,20590,20591,20592,20593,20594,20595,20596,20597,20598,20599,20600,20601,20602,20603,20604,20605,20606,20607,20608,20609,20610,20611,20612,20613,20614,20615,20616,20617,20618,20620,20621,20622,20623,20624,20625,20626,20627,20628,20629,20630,21299,21300,21301,21302,21359,21360,21362,22025,22026,22027,22030,22034,22036,22037,22039,22041,22042,22043,22044,22047,22050,22051,22052,22059,22062,22063,22064,22065,22066,22067,22068,22069,22070,27701,27702,27722,27723,27724,27725,27726,27727,27728,27729,27730,27731,27732,27733,27734,27735,27736,27737,27738,27739,27740,27741,27742,27743,27744,27745,27746,27747,27748,27749,28165,28166,28215,28216,28217,28867,28868,20631,20632,20633,20634,20635,20636,20637,20638,20639,20640,20641,20642,20643,20644,20645,20646,20647,20648,20649,20650,20651,20652,20653,20654,20655,20656,20657,20658,20659,20660,20661,20662,20663,20664,20665,20666,20667,20668,20669,20670,20671,20672,20673,20674,20675,20676,20677,20678,20679,20680,20681,20682,20683,20684,20685,20686,20687,20688,20689,20690,20691,20692,20693,20694,20695,20696,20697,20698,20699,20700,20701,20702,20703,20704,20705,20706,20707,20708,20709,20710,20712,20713,21277,21278,21279,24439,24440,24441,24442,24443,24444,24445,24446,24447,28163,28164,28167,28168,28169,28170,28171,28172,25351,25352,25353,25354,25355,25356,25357,25358,25359,27644,27645,27646,27647,27648,27649,27650,27651,27652,27653,27654,27655,27656,27657,27658,27659,27660,27661,27662,27663,27664,27665,27666,27667,27668,27669,27670,27671,27672,27673,27674,27675,27676,27677,27678,27679,27680,27681,27682,27683,27684,27685,27686,27687,27688,27689,27690,27691,27692,27693,27694,27708,27709,27710,27711,27712,27713,27714,27715,27716,27717,27718,27443,27444,27445,27446,27447,27448,27449,27450,27451,27695,27696,27697,27698,27699,27700,20019,20714,20715,20716,20717,20718,20719,20720,20721,20722,20723,20724,20725,20726,20727,20728,20729,20730,20731,20732,20733,20734,20735,20736,20737,20738,20739,20740,20741,20742,20743,20744,20745,20746,20747,20748,20749,20750,20751,20752,20753,20754,20755,20756,20757,20758,20759,20760,20761,20762,20763,20764,20765,20766,20767,20768,20769,20770,20771,20772,20773,20774,20776,20777,20778,20779,20780,20782,22019,22020,22021,22022,22023,22024,25433,25434,25435,25436,25437,25438,25439,25440,25441,25442,25443,25444,25445,25446,25447,25448,25449,25450,25451,25452,25453,25454,25455,25456,25457,25458,25459,25460,25461,25462,25463,25464,25465,25466,25467,25468,25469,25470,25471,25472,25473,25474,25475,25476,25477,25478,25479,25480,25481,25482,25483,25484,25485,25486,25487,25488,25489,25490,25491,25492,25493,25494,25495,25496,25497,25498,25499,25501,25502,25503,25504,25505,25507,27623,27624,27625,27626,27627,27628,27638,27639,27640,27641,27642,27643,20783,20784,20785,20786,20787,20809,20825,20826,20837,27631,27632,27633,27634,27635,27636,20852,20853,20854,20855,20856,20857,20858,20859,20860,20861,20862,20863,20864,20865,20866,20867,20868,20869,20870,20871,20872,20873,20874,20875,20876,20877,20878,20879,20880,20881,20882,20883,20884,20885,20886,20887,20888,20889,20890,20891,20892,20893,20894,20895,20896,20897,20898,20899,20900,20901,20902,20903,20904,20905,20906,20907,20908,20909,20910,20911,20912,20913,20914,20915,20916,20917,20918,20919,20920,20922,20923,20924,20925,20926,20927,20928,20929,20930,20931,20932,20933,20934,20935,20936,20937,20938,20939,20940,20941,20942,20943,20944,20945,20946,20947,20948,20949,20950,20951,20952,20953,20954,20955,20956,20957,20958,20959,20960,20961,20962,20963,20964,20965,20966,20967,20968,20969,20970,20971,20972,20973,20974,20975,20976,20977,20978,20979,20980,20981,20982,20983,20984,20985,20986,20987,20988,20989,20990,20991,20992,20993,20994,20995,20996,20997,20998,20999,21001,21002,13667,13673,13679,13685,21003,21004,21005,21006,21007,21008,21009,21010,21011,21012,21013,21014,21015,21016,21017,21018,21019,21020,21021,21022,21023,21024,21025,21026,21027,21028,21029,21030,21031,21032,21033,21034,21035,21036,21037,21038,21039,21040,21041,21042,21043,21044,21045,21046,21047,21048,21049,21050,21051,21052,21053,21054,21055,21056,21057,21058,21059,21060,21061,21062,21063,21064,21065,21066,21067,21068,21069,21070,21071,21072,21073,21074,21075,21076,21077,21078,21080,21081,21082,21083,21084,21085,21086,21087,21088,21089,21090,21091,21092,21093,21094,21095,21096,21097,21098,21099,21100,21101,21102,21103,21104,21105,21106,21107,21108,21109,21110,21111,21112,21113,21114,21115,21116,21117,21118,21119,21120,21121,21122,21123,21124,21125,21126,21127,21128,21129,21130,21131,21132,21133,21134,21135,21136,21137,21138,21139,21140,21141,21142,21143,21144,21145,21146,21147,21148,21149,21150,21151,21152,21153,21154,21155,21156,21157,21159,21160,27703,27704,27705,27706,27707,13645,13666,13672,13678,13684,29033,29034,29035,29036,29037,29038,29263,29264,29265,29266,21380,21381,21382,21383,21384,21385,21386,21387,21388,21389,21390,21391,21392,21393,21394,21395,21396,21397,21398,21399,21400,21401,21402,21403,28623,28624,28625,28626,28627,28628,28629,28630,28631,28632,28633,28634,28635,28636,28637,28638,28639,28640,28641,28642,28643,28644,28645,28646,28647,28648,28649,28650,28651,28652
)

# Remove duplicate IDs from the ids_bacen vector
ids_bacen <- unique(ids_bacen)

# TIME CONTROL -----------------------------------------------------------------

# Record the start time
start_time <- Sys.time()

# INSTALL AND LOAD PACKAGES ----------------------------------------------------

packages <- c('beepr', 
              'furrr', 
              'future', 
              'GetBCBData', 
              'lubridate', 
              'purrr', 
              'openxlsx',
              'rbcb', 
              'readxl', 
              'tibble', 
              'tidyverse', 
              'writexl')

for (pkg in packages) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg, method = "wininet")
  }
  library(pkg, character.only = TRUE)
}

# data inicial
data_ini = "1995-01-01"

# PARALLEL COMPUTING -----------------------------------------------------------

plan(multisession, workers = future::availableCores() - 1)

# FUNCTION TO DOWNLOAD DATA ----------------------------------------------------

# Define the function to download data
download_data <- function(id, max_attempts = 3) {
  attempt <- 1
  success <- FALSE
  result <- NULL
  
  while(attempt <= max_attempts && !success) {
    tryCatch(
      {
        df <- gbcbd_get_series(
          id = id,
          first.date = data_ini,
          last.date  = Sys.Date()
        )
        # Check if the data frame is empty
        if (nrow(df) == 0) {
          stop("Data frame is empty")
        }
        success <- TRUE
        result <- df
      },
      error = function(e) {
        message(paste("Failed to download data for id", id, "- attempt", attempt, "of", max_attempts))
        Sys.sleep(1)  # wait for 1 second before retrying
        attempt <- attempt + 1
      },
      warning = function(w) {
        message(paste("Warning for id", id, ":", conditionMessage(w)))
        attempt <- attempt + 1
      }
    )
  }
  
  if (!success) {
    stop(paste("Failed to download data for id", id, "after", max_attempts, "attempts"))
  }
  
  return(result)
}

# Use future_map to download data in parallel
df1 <- future_map(ids_bacen, ~download_data(.x), .progress = TRUE)

# Combine results into a single data frame
df2 <- bind_rows(df1)

# Perform additional checks to verify data integrity
if(any(is.null(df2)) || nrow(df2) == 0) {
  stop("Data download failed or resulted in empty data frame.")
}

# Inspect the first few rows of the combined data frame
head(df2)

# ------------------------------------------------------------------------------
# TRATAMENTO
# ------------------------------------------------------------------------------

unique(df2$id.num)
length(unique(df2$id.num))

# delete column:
df2$series.name = NULL

# rename colnames:
df3 <- df2 %>%
  rename(
    data   = ref.date,
    codigo = id.num,
    valor  = value
  )

# Remove duplicate rows from the dataframe
df3 <- df3 %>% distinct()

# ------------------------------------------------------------------------------

# Transform the dataframe from long to wide
df4 <- pivot_wider(df3, names_from = codigo, values_from = valor)

# Sort the dataframe by the data column
df4 <- df4 %>%
  arrange(data)

# ------------------------------------------------------------------------------

# save to rdata file:
save(df4, file = 
       paste0(output_folder, "/", file_name, "-", Sys.Date(), ".rdata")
     )

save(df4, file = 
       paste0(output_folder, "/", file_name, "-atual.rdata")
)

# save to xlsx:
write.xlsx(df4, file = 
             paste0(output_folder, "/", file_name, "-", Sys.Date(), ".xlsx")
           )

# save to xlsx:
write.xlsx(df4, file = 
             paste0(output_folder, "/", file_name, "-atual.xlsx")
)

# BEEP -------------------------------------------------------------------------

beep(sound = "coin")

# TIME CONTROL -----------------------------------------------------------------

# Record the end time
end_time <- Sys.time()

# Calculate the duration
duration <- end_time - start_time

# Extract hours, minutes, and seconds
hours <- as.numeric(duration, units = "hours") %/% 1
minutes <- as.numeric(duration, units = "mins") %/% 1 %% 60
seconds <- as.numeric(duration, units = "secs") %/% 1 %% 60

# Format the duration as hh:mm:ss
formatted_duration <- sprintf("%02d:%02d:%02d", hours, minutes, seconds)

# TEMPO DE EXECUÇÃO
print(formatted_duration)

# END --------------------------------------------------------------------------
