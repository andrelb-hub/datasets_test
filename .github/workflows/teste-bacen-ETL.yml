name: Run BACEN Data Script

on:
  schedule:
    - cron: '17 12 6 3 *'  # March 6th, 9:17 AM São Paulo (UTC-3)
    - cron: '19 12 7 4 *'  # April 7th, 9:19 AM São Paulo (UTC-3)

jobs:
  run_script:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.2.0' # Or your desired R version

      - name: Install R packages if needed
        run: |
          R_PACKAGES="beepr furrr future GetBCBData lubridate openxlsx purrr ragg rbcb readxl tibble tidyverse writexl"
          INSTALLED_PACKAGES=$(Rscript -e "paste(.packages(all.available = TRUE), collapse = ' ')")
          MISSING_PACKAGES=$(echo "$R_PACKAGES" | tr ' ' '\n' | grep -vxF -f <(echo "$INSTALLED_PACKAGES" | tr ' ' '\n'))
          if [[ -n "$MISSING_PACKAGES" ]]; then
            Rscript -e "install.packages(c($(echo "$MISSING_PACKAGES" | tr '\n' ',')))"
          fi

      - name: Run R script
        run: Rscript fetch_bacen_data.R

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update bacen data"
          file_pattern: bacen/lake/*.xlsx bacen/lake/*.rdata